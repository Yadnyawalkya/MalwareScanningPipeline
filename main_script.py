import csv
import re
import os
import pandas as pd
import yaml
from malware_scanner import create_logs_folder, process_repository, generate_html_table
from google_drive import authenticate_google_drive


def load_config():
    with open("config.yaml", "r") as file:
        config = yaml.safe_load(file)
    return config


if __name__ == "__main__":
    create_logs_folder()

    csv_file = "database.csv"

    if not os.path.exists(os.path.join("logs", csv_file)):
        header = [
            "Date and Time",
            "Repository Name",
            "Known Viruses in Database",
            "Scanned Directories",
            "Scanned Files",
            "Infected Files",
            "Result",
        ]
        with open(os.path.join("logs", csv_file), "w", newline="") as csvfile:
            csv_writer = csv.writer(csvfile)
            csv_writer.writerow(header)

    drive_service = authenticate_google_drive()

    for repo_url in load_config()["repo_urls"]:
        process_repository(repo_url, csv_file, drive_service)

    generate_html_table(csv_file)
